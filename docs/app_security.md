# Авторизация mini_app редактора

1. Inline-кнопка для открытия Mini App содержит ссылку на веб-приложение с дополнительными параметрами — message_id, который идентифицирует составное сообщение (описание, промпт и связанные медиафайлы в Telegram) и chat указывающий в чате или группе нажата кнопка. Если нужно открыть редактор с чистой формой, параметр message_id либо отсутствует, либо имеет значение null.
2. После нажатия кнопки Telegram открывает встроенный браузер (WebView) и загружает указанную страницу. При этом к URL автоматически добавляются служебные параметры от Telegram, включая:
    - данные о пользователе (ID, имя и т.д.),
    - временную метку авторизации (auth_date),
    - криптографическую подпись (hash).
Всё это передаётся в виде строки tgWebAppData.
Помимо этого, в URL остаётся параметр message_id.
3. JavaScript-код на странице считывает:
    - message_id, chat из URL-параметров,
    - tgWebAppData через window.Telegram.WebApp.initData.
    Сохраняет message_id, chat и user (из initData) в глобальное хранилище.
    В первом запросе (POST /api/init) для инициализации сессии передает initData и message_id.
4. Сервер получает запрос, извлекает tgWebAppData и:
    - вычисляет HMAC-SHA256 хеш на основе строки данных и секретного ключа (который равен SHA256 от токена Telegram-бота),
    - сравнивает полученный хеш с тем, что пришёл в tgWebAppData,
    - проверяет, что auth_date не устарел (допускается разница до 15 минут).
Если проверка пройдена, сервер доверяет данным и считает, что запрос действительно от указанного пользователя Telegram.
5. После успешной валидации сервер:
    - генерирует JWT-токен (с хранением HTTP-only cookie) и возвращает его клиенту,
    - по полученному message_id ищет соответствующую запись в базе данных, получает промпт
    - Находит шаблон по версии промпта или по умолчанию, если message_id не передан
    - проверяет, что текущий пользователь (user.id из tgWebAppData) имеет право на доступ к этой записи,
    - возвращает клиенту JWT-токен, данные составного сообщения (текст, список file_id медиа). А так же шаблон, промпт (может быть пустым) и тип промпта.
