# JSON-шаблон, форма, входной и выходной объект: спецификация

Этот шаблон описывает структуру формы и формат выходного JSON-объекта. Он используется для генерации HTML-интерфейса и последующего сбора пользовательских данных. Все поля имеют тип, метку (`label`) и значение по умолчанию (`default`). Структура может быть вложенной и произвольной.

## Типы полей

| Тип        | Описание |
|------------|----------|
| `text`     | Однострочное текстовое поле |
| `number`   | Числовой ввод |
| `textarea` | Многострочное текстовое поле, автоматически растягивается по содержимому |
| `select`   | Выпадающий список с вариантами |
| `checkbox` | Множественный выбор (чекбоксы с вариантами) |
| `color`    | Выбор цвета в HEX-формате |
| `array`    | Массив объектов, каждый из которых описан как вложенный JSON |
| `spoiler`  | Строковое поле, размещаемое первым внутри объекта. Указывает генератору формы, что весь блок должен быть визуально свернут (collapsible), с заголовком из значения `spoiler`. Не влияет на структуру выходного JSON. |
| `version`  | Версия шаблона, фиксированное значение, присутствует в шаблоне и в выходных данных |


## Структура поля

```json
"field_name": {
  "type": "text | number | textarea | select | checkbox | color | array | spoiler | version",
  "label": "Человекочитаемая метка",
  "default": "Значение по умолчанию",
  "options": [ { "value": "...", "label": "..." } ] // только для select и checkbox
}
```

### Пример шаблона
```json
{
  "version": {
    "type": "version",
    "label": "Версия шаблона",
    "default": "1.0.0"
  },
  "title": {
    "type": "text",
    "label": "Название ролика",
    "default": ""
  },
  "transition": {
    "type": "select",
    "label": "Тип перехода",
    "options": [
      { "value": "none", "label": "Нет" },
      { "value": "fade", "label": "Плавный" }
    ],
    "default": "none"
  },
  "features": {
    "type": "checkbox",
    "label": "Дополнительные эффекты",
    "options": [
      { "value": "sound", "label": "Звук" },
      { "value": "subtitles", "label": "Субтитры" }
    ],
    "default": []
  },
  "overlay": {
    "spoiler": "Надписи на экране",
    "text_overlay": {
      "type": "array",
      "label": "Надписи",
      "items": [
        {
          "spoiler": "Надпись 1",
          "text": {
            "type": "text",
            "label": "Текст надписи",
            "default": ""
          }
        }
      ]
    }
  }
}
```

## Спецификация генерации формы из JSON-шаблона

По JSON шаблону генерируется HTML-форма, где каждый элемент связан с `data-path`, отражающим путь к значению в выходном JSON. Спойлеры (`"spoiler": "..."`) интерпретируются как свернутые блоки (`<details>`).

### Общие правила

- Каждый ключ шаблона — это либо поле, либо вложенный объект.
- Если объект содержит `"spoiler": "..."`, он должен быть обёрнут в `<details><summary>...</summary>...</details>`.
- Все поля должны иметь:
  - `type`: тип поля
  - `label`: метку для отображения
  - `default`: значение по умолчанию
  - `options`: только для `select` и `checkbox`
- Для массивов (`type: "array"`) нужно повторить вложенные элементы с индексами: `data-path="block.items[0].field"`.

### Соответствие типов полей HTML-тегам

| Тип поля     | HTML-структура | Пример |
|--------------|----------------|--------|
| `text`       | `<input type="text" data-path="..." placeholder="...">` | Название ролика |
| `number`     | `<input type="number" data-path="..." placeholder="...">` | Длительность |
| `textarea`   | `<textarea data-path="..." placeholder="..."></textarea>` | Описание |
| `select`     | `<select data-path="..."><option value="...">...</option></select>` | Тип перехода |
| `checkbox`   | `<input type="checkbox" data-path="..." value="...">` (массив) | Доп. эффекты |
| `color`      | `<input type="color" data-path="..." value="...">` | Цвет акцента |
| `version`    | `<input type="hidden" data-path="..." value="...">` или readonly | Версия шаблона |
| `spoiler`    | `<details><summary>...</summary>...</details>` | Надписи на экране |
| `array`      | Повторяющийся блок с вложенными полями, индексируемыми в `data-path` | Надписи[0], Надписи[1] |

### Примеры обработки полей

#### Название ролика
```html
<label>Название ролика</label>
<input type="text" data-path="title" placeholder="Введите название">
```
Однострочное текстовое поле. Значение сохраняется в title.

#### Тип перехода
```html
<label>Тип перехода</label>
<select data-path="transition">
  <option value="none">Нет</option>
  <option value="fade">Плавный</option>
</select>
```
Выпадающий список с выбором одного варианта. Значение сохраняется в transition.

#### Дополнительные эффекты
```html
<label>Дополнительные эффекты</label><br>
<label><input type="checkbox" data-path="features" value="sound"> Звук</label><br>
<label><input type="checkbox" data-path="features" value="subtitles"> Субтитры</label>
```
Множественный выбор. Выбранные значения собираются в массив features.

#### Надписи на экране (спойлер)
```html
<details>
  <summary>Надписи на экране</summary>

  <div data-path="overlay.text_overlay[0]">
    <details>
      <summary>Надпись 1</summary>
      <label>Текст надписи</label>
      <input type="text" data-path="overlay.text_overlay[0].text" placeholder="Введите текст">
    </details>
  </div>

</details>
```
Свернутый блок с массивом объектов. Каждый объект тоже под спойлером и содержит одно текстовое поле.

## Спецификация генерации выходного JSON по шаблону формы

Выходной JSON формируется на основе значений, введённых пользователем в HTML-форму, с учётом структуры и типов, описанных во входном шаблоне. Все значения собираются по `data-path`, соответствующему пути в шаблоне.

### Общие правила

- Структура выходного JSON полностью повторяет структуру шаблона, но:
  - Исключаются все мета-поля (`type`, `label`, `options`, `spoiler`)
  - Остаются только ключи и значения, введённые пользователем
- Значения берутся из соответствующих HTML-элементов по `data-path`
- Пустые поля должны быть опущены
- Массивы (`type: "array"`) сериализуются как массив объектов
- Спойлеры (`"spoiler": "..."`) не влияют на структуру и не включаются в JSON

### Правила по типам полей

| Тип поля     | Формат в JSON | Пример значения |
|--------------|----------------|-----------------|
| `text`       | Строка         | `"title": "Мой ролик"` |
| `number`     | Число          | `"duration": 60` |
| `textarea`   | Строка         | `"description": "Описание ролика"` |
| `select`     | Строка (одно значение из `options.value`) | `"transition": "fade"` |
| `checkbox`   | Массив строк (выбранные `value`) | `"features": ["sound", "subtitles"]` |
| `color`      | Строка HEX     | `"accent": "#ff9900"` |
| `version`    | Строка         | `"version": "1.0.0"` |
| `array`      | Массив объектов | `"items": [ { ... }, { ... } ]` |
| `spoiler`    | — (игнорируется) | — |


### Пример выходного json объекта

```json
{
  "version": "1.0.0",
  "title": "Приветствие",
  "transition": "fade",
  "features": ["sound", "subtitles"],
  "overlay": {
    "text_overlay": [
      {
        "text": "Добро пожаловать!"
      }
    ]
  }
}
```

## Спецификация заполнения формы по JSON-объекту

Алгоритм принимает валидный JSON-объект (например, результат заполнения формы) и заполняет HTML-форму, сгенерированную по шаблону. Каждое поле формы связано с `data-path`, отражающим путь к значению.

### Общие принципы

- Каждое значение из JSON-объекта вставляется в соответствующий HTML-элемент по `data-path`.
- Если значение отсутствует — используется `default` из шаблона.
- Если значение присутствует, но поле не найдено — игнорируется или логируется как ошибка.
- Для массивов: если количество элементов в JSON больше, чем в шаблоне — создаются дополнительные элементы формы.
- Дополнительные элементы массива создаются из **глубокой копии шаблонного фрагмента**, получаемого через функцию `getEmptyFragment(path)`.

### Поведение по типам

| Тип поля     | Поведение при заполнении |
|--------------|--------------------------|
| `text`       | Устанавливается `value` в `<input type="text">` |
| `number`     | Устанавливается `value` в `<input type="number">` |
| `textarea`   | Устанавливается `value` в `<textarea>` |
| `select`     | Выбирается `<option>` по `value` |
| `checkbox`   | Отмечаются `<input type="checkbox">` по совпадению `value` |
| `color`      | Устанавливается `value` в `<input type="color">` |
| `version`    | Устанавливается `value` в `<input type="readonly">` |
| `array`      | Для каждого элемента массива создаётся блок формы. Если элементов больше, чем в шаблоне — вызывается `getEmptyFragment(path)` |
| `spoiler`    | Не влияет на данные, только на визуальное отображение |

## Работа с массивами

- При загрузке формы создаётся **глубокая копия шаблонного элемента массива**:
```js
  const emptyItem = getEmptyFragment("overlay.text_overlay");
```

Если JSON содержит N элементов, а шаблон — M, то:

    - Если N ≤ M: заполняются существующие элементы

    - Если N > M: создаются N - M дополнительных блоков через getEmptyFragment(path)

Каждый элемент массива получает индексированный data-path, например:
```js
<input data-path="overlay.text_overlay[2].text">
```

## Пример

```json
{
  "title": "Приветствие",
  "transition": "fade",
  "features": ["sound"],
  "overlay": {
    "text_overlay": [
      { "text": "Добро пожаловать!" },
      { "text": "Подпишитесь на канал" }
    ]
  }
}
```
### Поведение
- title → `<input data-path="title" value="Приветствие">`
- transition → `<select data-path="transition">` → выбрано "fade"
- features → чекбокс "sound" отмечен
- overlay.text_overlay → создаются 2 блока:
    - Первый заполняется
    - Второй создаётся через getEmptyFragment("overlay.text_overlay") и заполняется

## Особенности
- getEmptyFragment(path) должен возвращать глубокую копию шаблонного элемента по указанному пути.
- Спойлеры ("spoiler": "...") не участвуют в заполнении, но должны сохранять структуру свернутых блоков.
- Алгоритм должен быть устойчив к отсутствующим или лишним данным.
