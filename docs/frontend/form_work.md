# Описание работы формы

## Изменяемые файлы
- services/web_app/templates/web_app.html - веб приложение
- services/web_app/static/form.js - контекстное меню, обработка событий
- services/web_app/static/form_work.js - функции действий

## Используемые функции
Изучить интерфейс функций перед использованием. Документация @docs/index.md.
- Сообщения о действиях выводятся через специальную функцию showNotification в файле @services/web_app/static/script.js. Соответствующее сообщение выводится после совершения действия любой кнопкой.
- createForm @services/web_app/static/create_form.js функция для создания формы или ее части.

## Примечания
- Активный объект (элемент) - тот, чья кнопка вызвала событие
- Для нахождения объекта массива - находим первый элемент со свойством data-path, вверх по иерархии от кнопки.
- id активного элемента равен его data-path.
- Свойство data-parent активного элемента указавает на контейнер содержащий все объекты массива. 
- имя объекта - последняя часть data-path, та, что после точки, заканчивается подчеркиванием и числом, например: scene_18 для scenes.scene_18

## Новые функции

### Функция пересчета путей "newPath"
Нужна для обработки путей внутри объектов массива при перестановке (изменении индекса).
Свойства: for, data-path, id, data-target, data-parent элементов могут содержать пути в которых шаблон нужно поменять на другой. Например в пути: scenes.scene_1.title меняем scene_1 на scene_2 и получаем scenes.scene_2.title.
Свойство data-id некоторых элементов содержит индекс, для scene_1 там будет 1, для scene_2 меняем на 2.
В элементе со свойством data-role="title" значение состоит из 2 частей, названия и индекса (через пробел), например Сцена 1. Находим число внутри значения и меняем на новое значение data-id.
Функция принимает ссылку на элемент внутри dom дерева, шаблон: например scene_1 и новый индекс, например 2. Подготавливает замену для шаблона, например scene_2. Рекурсивно проходит по дереву, находит нужные элементы и свойства и меняет их соответствующим образом.

### Функция для сдвига объектов "shiftUp"
- Принимает ссылку на контейнер в dom дереве и id активного объекта
- Совершает операции прямо в dom.
- Перебирает все элементы контейнера по очереди начиная с конца и до активного элемента включительно.
- Если элемент, с новым id в контейнере уже есть, удаляем его перед заменой путей в текущем.
- Имя объекта - это шаблон который нужно поменять в путях внутри него. Индекс этого элемента в его свойстве data-id. Новый индекс - это число на 1 больше его индекса. Например для нашего примера scenes.scene_1: scene_1 - шаблон, индекс (data-id) - 1, новый индекс 2.
- Меняет пути функцией "newPath".

### Функция для сдвига объектов "shiftDown"
Функция сдвига обратная "shiftUp".

## Кнопки и события
- основные кнопки на динамически создаваемой форме
- кнопки (пункты) контекстного меню в документе
- все кнопки имеют атрибут data-action с меткой действия
- события перехватываются на document.body
- функция открытия контекстного меню в form.js
- функция обработки событий в form.js вызывают функции действий
- функции действий в файле form_work.js

## Кнопки в форме

### Очистить (data-action="clear-items")
Очищает весь массив. Удаляет часть dom с массивом и вставляет на его место чистый массив созданный заново. Для нажатой кнопки находим первый родительский элемент со свойством data-path, для массива это его корневой элемент. По data-path этого элемента создаем его чистую копию с помощью функции createForm. И вставляем его в dom вместо старого массива с этим id.

### Добавить (data-action="add-item")
Добавляет новый объект в конец массива.
Свойство data-target кнопки содержит id контейнера, содержащего все объекты массива в форме. Нужно посчитать их количество, пусть это X. И создать чистый элемент. Для этого расчитать новый путь: к data-target добавить "_" X+1. Полученный путь передать в createForm и смонтировать полученый результат последним в контейнер data-target.

### Действия (data-action="object-menu")
Открывает контекстного меню для работы с объектом массива

## Кнопки (пункты) контекстного меню

### Добавить перед (data-action="add")
Добавляет объект массива перед активным 
- Запоминает путь из data-path активного элемента.
- Сдвигает объекты функцией "shiftUp"
- Передает в функцию newPath ссылку на активный элемент, шаблон и новый индекс.
- Создаем чистый элемент с запомненным путем с помощью функции createForm.
- Меняем им в dom активный элемент.

### Клонировать (data-action="clone")
Добавляет копию активного объекта после него.
- Находим активный объект, его `data-path` и индекс.
- Вызываем функцию `shiftUp` для всех элементов, идущих *после* активного. Это сдвигает их на одну позицию вниз, освобождая место для клона.
- Создаем глубокую копию активного элемента (`cloneNode(true)`).
- Для клона вызываем функцию `newPath`, чтобы обновить все его внутренние пути, `id` и `data-id` на новый индекс (индекс активного элемента + 1).
- Вставляем обновленный клон в DOM сразу после активного элемента.

### Выше (data-action="move-up")
Перемещает активный элемент на 1 позицию выше, если он еще не равен 1.
- Запоминает data-id активного объекта и его имя.
- Находит в контейнере объект с индексом на 1 меньше активного, если такой есть, если нет - просто выводит соответствующее сообщение.
- Делает копию найденного объекта, запоминает его data-id и имя. Удаляет из dom.
- Меняет пути функцией "newPath" в активном объекте используя его имя как шаблон, и data-id найденного объекта как новый индекс.
- Меняет пути в запомненном объекте используя в качестве шаблона его имя и исходный data-id активного объекта.
- Вставляет обновленный объект после бывшего активного.

### Ниже (data-action="move-down")
Проделывает те же операции, что для кнопки Выше, но для сдвига активного объекта вниз.
Если у него максимальный id, равен количеству элементов в контейнере, то сдвиг не совершается, выводится соответствующее сообщение.

### Очистить (data-action="clear")
Удаляет содержимое объекта. Для этого удаляет и создает новый объект массива в замен старого. Создаем чистый объект, передавая путь в createForm. Полученный код монтируем в dom вместо очищаемего.

### Удалить (data-action="delete")
- Сдвигает объекты функцией "shiftDown", если удаляемый объект не последний в контейнере.
- Удаляет последний элемент.
